# yii2.0 RESTful路由 #
## 添加API应用入口 ##
创建文件夹api,
复制frontend至api,
- 
environments/dev/frontend至environments/dev/api

- environments/prod/frontend至environments/prod/api

- 调整命名空间和路径，以api开头替换frontend

- 在common\config\bootstrap.php中添加以下代码
		Yii::setAlias('@api', dirname(dirname(__DIR__)) . '/api');

在api/config/main.php中 ，修改id和命名空间

	'id' => 'app-api',
	'basePath' => dirname(__DIR__),
	'controllerNamespace' => 'api\controllers',

创建第一个API应用 

在controllers下创建PostController.php

	<?php
		namespace api\controllers;
	
	
		use common\models\Post;
		use yii\rest\ActiveController;
	
		class PostController extends ActiveController{
	
			public $modelClass='common\models\Post';
			
		}
在配置文件main.php中，针对post控制器的url进行美化规则配置


	'urlManager' => [
	    'enablePrettyUrl' => true,
	    'enableStrictParsing' => true,
	    'showScriptName' => false,
	    'rules' => [
	    	[
	    		'class'=>'yii\rest\UrlRule',
	            'controller' => 'post',
	            'extraPatterns' => [
	            	'POST search'=>'search'
	            ],
	        ],
		],
	],

配置文件main-local.php，让API应用能够接受json格式的输入数据


	'components' => [
        'request' => [
            // !!! insert a secret key in the following (if it is empty) - this is required by cookie validation
            'cookieValidationKey' => 'j_4cyGvRXl_-lAXFYiRpnLG0S432YUz0',
	        'parsers' => [
	        	'application/json'=>'yii\web\JsonParser'
	        ],
        ],
    ],

## RESTful ##
RESTful是设计API应用的一种风格。
### RESTful风格的特点 ###
- 用资源来表示对象或者数据库中的数据，每个资源都有一个唯一的请求地址，也成为末端(endpoint)

		http://192.168.43.226:8093/posts/32
在url中，只有名词，没有动词，名词使用复数形式
通常，一种数据具有两种类型的资源
一种是数据的集合

		http://192.168.43.226:8093/posts/
一种是配上id表示数据的个体

		http://192.168.43.226:8093/posts/32

- 用http动词来对资源进行操作
	1. GET  		获取数据详细
	1. POST			创建数据
	1. PUT或PATCH	修改数据
	1. DELETE		删除数据
	1. OPTIONS		显示末端支持的动词
	1. HEAD			获取http头信息


## yii api字段调整 ##
### 数据是如何进行格式转换 ###
1. 首先是内容协商。客户端在向服务端发送数据的时候，会通过http请求头信息中的Accept提出一些请求，比如媒介类型，语言，版本等方面的要求。

1. 服务端收到请求后，首先要准备资源数据，资源数据是以对象或者集合的形式存在的，为了最终能转换成字符串输出，这一步会先把对象或者集合转成数组，转换是用 yii\rest\Serializer类进行的

1. 得到数组后，服务端再根据第一步的内容协商，客户端提出的要求，把数组转换成相应格式的字符串返回。

### 字段的自定义设置 ###
可以重写模型类中的fields()或者extraFields()方法，根据需求设置字段以及字段的值，这样，Serializer转换出来的数组就是我们需要的数据了。

- 在客户端发送的API请求地址上，通过fields参数来指定需要的字段	
		http://localhost:8093/posts?fields=title,content
- 重写fields方法来之地你给需要的字段还可以自定义字段名。
		 public function fields()
			{
				return [
					'id',
					'title',
					'content',
					'status'=>function($model){
						return $model->status0->name;
					},
					'createdBy'=>function($model){
						return $model->author->nickname;
					}
				];
			}

## yii api 自定义分页 ##
1. 首先重写actions方法，在方法数组中删除index方法。
		public function actions()
		{
			$actions=parent::actions(); // TODO: Change the autogenerated stub
			unset($actions['index']);
			return $actions;
		}
1. 重写index方法
		public function  actionIndex(){
			$modelClass=$this->modelClass;
			return new ActiveDataProvider(
				[
					'query'=>$modelClass::find()->asArray(),
					'pagination'=>['pageSize'=>5],
				]
			);
		}
1. 客户端用page来指定需要的页码
		http://localhost:8093/posts?page=3

## yii api按关键字搜索 ##
1. 控制器中增加actionSearch方法
		public function actionSearch(){
			return Post::find()->where(['like','title',$_POST['keyword']])->all();
		}
2. 在main.php中配置符合restful风格的搜索url
		'rules' => [
            	[
            		'class'=>'yii\rest\UrlRule',
		            'controller' => 'post',
		            'extraPatterns' => [
		            	'POST search'=>'search'
		            ],
	            ],
		]

## yii api中自定义资源 ##
1. 新建一个控制器类
		<?php
			namespace api\controllers;
			use yii\rest\Controller;
			use yii\db\Query;
			class Top10Controller extends Controller{
				public function actionIndex(){
					$top10=(new Query())->from('post')
						->select(['author_id','count(id) as creatercount'])
						->groupBy(['author_id'])->orderBy('creatercount desc')
						->limit(10)->all();
					return $top10;
				}
			}

2. 配置符合RESTful风格的url规则
		'rules' => [
            [
            	'class'=>'yii\rest\UrlRule',
	            'controller' => 'top10',
	            'pluralize' => false  //如果为false，则url为http://api.blog.com/top10否则为http://api.blog.com/top10s
            ],
		]

url规则中
- 关闭url名词复数形式
		'pluralize' => false  
- 禁用一些http动词
		'except' => ['delete','update','create','view']


## yii api 认证 ##

1. 在main.php中 修改认证类
		 'user' => [
		            'identityClass' => 'common\models\User',
		            'enableAutoLogin' => true,
			        'enableSession' => false,
		        ],

	把cookie和session的设置都去掉

1. 存取令牌
  1. 在api/models下创建ApiLoginForm.php,这个文件的作用
	- 接收客户端传输过来的用户名和密码
	- 验证密码是否正确
	- 调用验证类对象生成存取令牌
	- 保存存取令牌到用户表
  1. 在api/controllers下创建UserController.php，这个文件作用
 	- 用户登录
 	- 用户注册
1. 设置url美化规则
		[
        	'class'=>'yii\rest\UrlRule',
            'controller' => 'user',
            'except' => ['delete','update','create','view'],
            'pluralize' => false,
            'extraPatterns' => [
            	'POST login'=>'login',
            	'POST signup'=>'signup',
            ]
        ],

1. 维持认证状态 
维持认证状态，就是客户端如何用accessToken这个令牌，去访问服务端提供的服务
  1. 添加QueryParamAuth过滤器
  		  public function behaviors()
			{
			  return ArrayHelper::merge(
				parent::behaviors(),
				[
					'authenticatior'=>[
						'class'=>QueryParamAuth::className()  //这是access_token认证
					]
				]
			);
		  }
	这时访问API会报Unauthorized错误。
	需要在访问API时带上accessToken
 1. 在user.php模型类中实现findIdentityByAccessToken方法
			public static function findIdentityByAccessToken($token, $type = null)
		    {
			    return static::findOne(['access_token'=>$token]);
		    }

1. API 认证的几个要点
   - 认证类
   - 认证方式
   - 安全问题
   1. 认证类 
   根据需求，灵活选择用户认证类。可以是user，也可以是adminuser,甚至专门的用户认证类。
   2. 认证方式
     1. 请求参数
     用QueryParamAuthor过滤器来实现认证。
     2. HTTP基本认证
     HTTP规范中所制定的最基本的认证方式，实现和简单，只需在响应中设置一个验证身份的Header即可。
				header('WWW-Authenricate:Basic realm="Test Auth"');
	 在yii框架中实现如下
				public function behaviors()
				{
					return ArrayHelper::merge(
						parent::behaviors(),
						[
							'authenticatior'=>[
								'class'=>HttpBasicAuth::class,  //这是Http认证
								'auth' => function($username,$password){
									$user=User::find()->where(['username'=>$username])->one();
									if ($user->validatePassword($password)){
										return $user;
									}
									return null;
								}
							]
						]
					);
				}
     3. OAuth 2
     OAuth2 是一种用户授权提供的，安全的，开放和简易的协议。
	 大致流程如下
		① 用户在客户端向服务端请求认证授权
		② 服务端会给客户端一个授权凭证
		③ 客户端使用授权凭证向认证服务器申请令牌
		④ 认证服务器验证无误后发放令牌。
		⑤ 客户端使用获得的令牌，向服务端请求资源
		⑥ 服务端确认无误后给客户端提供资源的调用

##  API 实现用户注册 ##